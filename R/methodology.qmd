---
title: "Methodology"
author: 
  - Jolyon Miles-Wilson
  - Celestin Okoroji
date: "`r format(Sys.time(), '%e %B %Y')`"
format: 
  html:
    self-contained: true
    code-fold: true
    code-tools: true
    code-summary: "Code"
    toc: true
    toc-depth: 5
execute: 
  echo: false
  warning: false
number-sections: true
---

```{r packages}
library(haven)
library(poLCA)
library(Hmisc)
library(dplyr)
library(ggplot2)
library(tidyr)
library(skimr)
library(kableExtra)
#library(MASS)
library(wesanderson)
library(ggrepel)
library(here)
library(emmeans)
#library(devtools)
#install_version("sjstats", version = "0.18.2")
library(sjstats)
library(readr)
library(sjPlot)
library(nnet)
```

```{r palette}
rm(list = ls())
options(scipen = 999)
colours <- wes_palette("GrandBudapest2",4,"discrete")
better_colours <- c('#8dd3c7','#bebada','#fb8072','#80b1d3','#fdb462')
many_colours <- c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','#ffff99','#b15928','#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462','#b3de69','#fccde5','#d9d9d9','#bc80bd','#ccebc5','#ffed6f')
```

```{r functions}
extract_glm_coefs <- function(mod, only_sig=F, decimal_places = 3){
  coefs <- coef(summary(mod)) 
  if(only_sig==T){
    coefs <- coefs[which(coefs[,4] < .05),]
  }
  coefs <- as_tibble(coefs, rownames="variable") %>% # specify new variable to add rownames to 
    mutate(
    or = round(exp(Estimate), decimal_places), .after=Estimate
    )
}

extract_lm_coefs <- function(mod, only_sig = F){
  coefs <- coef(summary(mod)) 
  if(only_sig==T){
    coefs <- coefs[which(coefs[,4] < .05),]
  }
  coefs <- as_tibble(coefs, rownames="variable") # specify new variable to add rownames to 
}

```

```{r data, output=FALSE}
data <- readRDS("../Data/2025-04-07 - Cleaned_data.rds")

# Specify data to be used in income analysis
income_data <- filter(data, income_drop_all==0)
```

```{r age_stats}
age_statistics <- data %>%
  summarise(
    mean = mean(Age, na.rm=T),
    median = median(Age, na.rm=T),
    min = min(Age,na.rm=T),
    max = max(Age,na.rm=T),
    stdev = sd(Age, na.rm=T),
    wtd_mean = weighted.mean(Age, w = NatRepemployees, na.rm = T),
    wtd_median = wtd.quantile(Age, w = NatRepemployees, probs = c(.5), na.rm = T),
    wtd_min = wtd.quantile(Age, w = NatRepemployees, probs = c(0), na.rm = T),
    wtd_max = wtd.quantile(Age, w = NatRepemployees, probs = c(1), na.rm = T),
    wtd_stdev = sqrt(wtd.var(Age, w = NatRepemployees, na.rm = T)),
    N = n()
  )

readr::write_csv(age_statistics, file = "../outputs/methodology/data/age_stats.csv")

```

```{r gender_stats}
gender_statistics <- data %>%
  group_by(Gender) %>%
  summarise(
    n = n(),
    Frequency = sum(NatRepemployees)
  ) %>%
  mutate(
    N = sum(n),
    Sum = sum(Frequency),
    percentage = 100 * (n / N),
    wtd_percentage = 100 * (Frequency / Sum)
  )

readr::write_csv(gender_statistics, file="../outputs/methodology/data/gender_statistics.csv")
```

```{r ethnicity_stats}
ethnicity_statistics <- data %>%
  group_by(Ethnicity_labelled) %>%
  summarise(
    n = n(), # count cases
    Frequency = sum(NatRepemployees) # count weighted cases
  ) %>%
  mutate(
    N = sum(n),
    Sum = sum(Frequency),
    percentage = 100 * (n / N),
    wtd_percentage = 100 * (Frequency / Sum)
  )

write_csv(ethnicity_statistics, file="../outputs/methodology/data/ethnicity_statistics_census.csv")
```


# Participants and Design

\[**Insert Name of Report**\] contains data from two studies. The first of these studies was a nationally representative survey of `r nrow(data)` \[**Workers?**\] conducted by Opinium Research between \[**Month Year**\].   This sample had median age `r age_statistics$median` (min = `r age_statistics$min`, max = `r age_statistics$max`).  `r round(gender_statistics$percentage[which(gender_statistics$Gender == "Female")],0)`% of respondents identified as female, `r round(gender_statistics$percentage[which(gender_statistics$Gender == "Male")],0)`% as male, `r round(gender_statistics$percentage[which(gender_statistics$Gender == "Other")],2)`% as other, and `r round(gender_statistics$percentage[which(gender_statistics$Gender == "Prefer not to say")],2)`% preferred not to identify a gender. `r round(ethnicity_statistics$percentage[which(ethnicity_statistics$Ethnicity_labelled == "English / Welsh / Scottish / Northern Irish / British")],0)`% of respondents identified as 'English / Welsh / Scottish / Northern Irish / British' (see @sec-ethnicity for a detailed breakdown of ethnicity). [**ADD POTENTIALLY POWER**]

The second study was a follow-up survey of \[**Outsourced Workers - need to check if they were from the original survey or not, but think they were not**\] conducted by Opinium Research between \[**Month Year**\] with a total sample of \[**INSERT SAMPLE**\]. The purpose of this study was to further probe the experiences of outsourced workers and to understand the impact of outsourcing on their work and lives. ADD INFORMATION ABOUT MEAN AGE, GENDER SPLIT and ETHNIC DIVERSITY AND POTENTIALLY POWER.

\[In both surveys??\] All statistics are weighted estimates based on \[**INSERT INFORMATION HERE - THIS IS NEEDED FROM OPINIUM**\]

-   How were the survey's administered?

\[**POTENTIALLY ADD A TABLE HERE WITH CROSSTABS FOR THE TWO SAMPLES OR TABBED VISUALISATIONS**\]

# Measures

## Study 1- Nationally representative survey

- [ ]    Explain the contents of the survey
- [ ]   I believe some questions were replicated from national survey's so lets explicate that
- [ ]  Discuss the issue of pay calcs (e.g. basic overview and then refer to the section on it)
- [ ]   Discuss the issue of defining outsourcing ((e.g. basic overview and then refer to the section on it))
- [ ]  link to the data dictionary

## Study 2 - Outsourced workers survey

- [ ]  Explain the contents of the survey and how the focus differeces from the first study
- [ ]  Outline the key areas e.g. Rights Violations etc
- [ ]  If there is any variable that is constructed then refer to it here briefly with a more verborse explanation in the relevant section
- [ ]  Link to data dictionary

# Analysis - Study 1

- [x]  Determining if the worker is outsourced
- [ ]  Calculating Low/Not Low pay
- [ ]  Explain the analyses (e.g. any models that actually appear in the final output)

## Defining outsourcing

Workers were defined as outsourced based on responses to a set of diagnostic questions. Three questions asked respondents directly about whether they considered themselves outsourced and/or agency workers.

The first of these questions asked respondents to indicate directly whether they considered themselves outsourced by selecting one of the following options:

1. I am sure I’m an outsourced worker
2. I think I might be an outsourced worker
3. I am not an outsourced worker

The second question asked respondents to indicate whether they considered themselves an agency worker by selecting from three options. For respondents who responded 1 or 2 to question 1, the options were:

1. I am sure that I’m also an agency worker
2. I think I might also be an agency worker
3. I am not an agency worker

For respondents who responded 3 to question 1, the options were:

1. I am sure that I’m an agency worker
2. I think I might be an agency worker
3. I am not an agency worker

Respondents were also asked whether the work they do was long- or short-term by selecting one of:

1. I’m hired to do work which an organisation needs doing on a long-term or ongoing basis.
2. I’m hired to do work which an organisation needs doing on a short-term or temporary basis.
3. Other (please specify)

Finally, respondents were asked about aspects of their work that might indicate that the work they do is outsourced work. Respondents were asked: "Please read each of the following statements and tell us whether or not they are true for you and your work." The statements were:

1. I am paid by one organisation but I do work for a different organisation.
2. The organisation I’m paid by is a ‘third party’ organisation which other organisations hire to do work for them, rather than doing that w [**FIND QUESTION IN DATA DICT**]
3. My employer / agency provides people to do work for other organisations (i.e. they might provide people to do cleaning, security, administratio [**FIND QUESTION IN DATA DICT**]
4. On a day-to-day basis, I’m paid by one organisation but I get given tasks or instructions by people who are paid by a different organisation.
5. I am paid by one organisation, but I work in a space which has the logo or branding of a different organisation.
6. I wear a uniform which has the logo or branding of my employer / agency, and which marks me out as being paid by a different organisation to so [**FIND QUESTION IN DATA DICT**]

Workers were categorised into three mutually exclusive sub groups based on their responses to the above questions.

1. A respondent was categorised as '**pure outsourced**' if they responded 'I am sure I'm an outsourced worker' or 'I think I might be an outsourced worker' **and** 'I’m hired to do work which an organisation needs doing on a long-term or ongoing basis.'.

2. A respondent was categorised as '**likely agency**' if they responded 'I am sure that I'm an agency worker' **and** 'I’m hired to do work which an organisation needs doing on a long-term or ongoing basis', **excluding** those people who are already defined as being 'pure outsourced'.

3. A respondent was categorised as belonging to the '**high indicators**' group if they responded TRUE to five or six of the outsourcing indicators, as well as responding 'I’m hired to do work which an organisation needs doing on a long-term or ongoing basis', **excluding** those people who were already defined as 'pure outsourced' or 'likely agency'.

Together, these three sub groups form the classification of 'outsourced workers' considered in this report. Throughout the report, the term 'outsourced' refers to workers across the three sub groups. In places, analysis considers the three sub groups separately, in which case the groups will be referred to by name as 'pure outsourced', 'likely agency', or 'high indicators'. 

# Analysis - Study 2

- [ ] Explain the analyses (e.g. any models that actually appear in the final output)

# Limitations and Future Research?

- [ ]  Discuss the limitations of the data and the analysis
- [ ]  If something is really burning we can suggest some futher analysis that people can do

# Reproducibility

- [ ] maybe this should go earlier but it would be good to add a section that shows how to reproduce the analysis and the data. But maybe this would duplicate the readme. Here i am just thinking of a step by step guide to reproduce the analysis and the data e.g. clone the repo, run the code for data cleaning then run.....

------------------------------------------------------------------------

# Age

The table below shows weighted descriptive statistics of the sample, and the figure below shows the frequency of respondents at each single year of age.

```{r}
age_statistics %>%
  dplyr::select(contains('wtd')) %>%
  knitr::kable(
             digits = 2,
             col.names = c("Mean",
                           "Median",
                           "Min",
                           "Max",
                           "Standard dev.")) %>%
  kable_styling(full_width = F)

age_range <- max(data$Age) - min(data$Age)
interval <- 1
n_bins <- (age_range / interval) + 1

data %>%
  ggplot(.,aes(Age)) +
  geom_histogram(colour="black",alpha = .7, bins = n_bins) +
  geom_vline(data =age_statistics, aes(xintercept=median), colour="red") +
  scale_x_continuous(breaks = seq(16, 80, 4)) +
  theme_minimal() +
  scale_colour_manual(values=colours, name = "Outsourcing status") +
  scale_fill_manual(values=colours, name = "Outsourcing status") +
  ylab("Count")
  

```

# Gender


The table below shows the weighted gender breakdown of the sample

```{r}
gender_statistics %>%
  dplyr::select(-percentage) %>%
  mutate(across(where(is.numeric), ~ round(.x, 2))) %>%
  dplyr::select(-c(n, N, Sum)) %>%
  kable(col.names = c(
    "Gender",
    "Weighted frequency",
    "Weighted percentage"
  )) %>%
  kable_styling(full_width = F)
```

# Ethnicity {#sec-ethnicity}

The table below shows the weighted ethnicity breakdown using the full range of Census 2021 categories. Note that 'NA' indicates non-responses.

```{r}
ethnicity_statistics %>%
  dplyr::select(-percentage) %>%
  mutate(across(where(is.numeric), ~ round(.x, 2))) %>%
  dplyr::select(-c(n, N, Sum)) %>%
  kable(col.names = c(
    "Ethnicity",
    "Weighted frequency",
    "Weighted percentage"
  )) %>%
  kable_styling(full_width = F)
```

We also make use of an aggregated ethnicity variable that groups ethnicities into fewer categories. The table below shows how the Census categories map onto the aggregated categories.

```{r}
ethnicity_cat <- data %>%
  dplyr::select(contains("ethnicity")) %>%
  distinct() %>%
  arrange(Ethnicity) %>%
  dplyr::select(-c(1:2,Ethnicity_collapsed_disaggregated, Ethnicity_binary))

write_csv(ethnicity_cat, file="../outputs/methodology/data/ethnicity_aggregation_mapping.csv")

ethn_colnames = c(
  "Census categories",
  "Aggregated categories"
)
ethnicity_cat %>%
  kable(col.names = ethn_colnames) %>%
  kable_styling(full_width=FALSE)
```

The table below shows the weighted ethnicity breakdown using the aggregated set of categories

```{r}
ethnicity_statistics_collapsed <- data %>%
  group_by(Ethnicity_collapsed) %>%
  summarise(
    n = n(), # count cases
    Frequency = sum(NatRepemployees) # count weighted cases
  ) %>%
  mutate(
    N = sum(n),
    Sum = sum(Frequency),
    Percentage = 100 * (Frequency / Sum),
    Ethnicity_short = Ethnicity_collapsed
  )

write_csv(ethnicity_statistics_collapsed, file="../outputs/methodology/data/ethnicity_statistics_aggregated.csv")

ethnicity_statistics_collapsed %>%
  mutate(across(where(is.numeric), ~ round(.x, 2))) %>%
  dplyr::select(-c(n, N, Sum, Ethnicity_short)) %>%
  kable(col.names = c(
    "Ethnicity",
    "Weighted frequency",
    "Weighted percentage"
  )) %>%
  kable_styling(full_width = F)
```
